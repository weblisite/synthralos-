# ============================================================================
# SynthralOS Render Blueprint Configuration
# ============================================================================
#
# Architecture:
# - Database: Supabase PostgreSQL (external service, not managed by Render)
# - Authentication: Supabase Auth (external service, not managed by Render)
# - Storage: Supabase Storage (external service, not managed by Render)
# - Backend: FastAPI service (deployed on Render)
# - Frontend: React/Vite service (deployed on Render)
#
# IMPORTANT: This blueprint does NOT include a Render database service.
# All database, authentication, and storage operations use Supabase.
# See docs/SUPABASE_DATABASE_MIGRATION.md for setup instructions.
#
# ============================================================================

services:
  # Backend API Service
  - type: web
    name: synthralos-backend
    runtime: docker
    dockerfilePath: ./backend/Dockerfile
    dockerContext: ./backend
    plan: standard  # Upgraded from starter (512MB) to standard (2GB) to fix memory issues
    buildCommand: ""
    healthCheckPath: /api/v1/utils/health-check
    envVars:
      # Render automatically provides PORT (defaults to 10000)
      # Explicitly set for clarity and to match Render's default
      - key: PORT
        value: "10000"
      - key: ENVIRONMENT
        value: production
      - key: PROJECT_NAME
        value: SynthralOS
      - key: API_V1_STR
        value: /api/v1
      - key: SECRET_KEY
        generateValue: true
      - key: ACCESS_TOKEN_EXPIRE_MINUTES
        value: "11520"  # 8 days

      # ========================================================================
      # Supabase Configuration (REQUIRED)
      # ========================================================================
      # Supabase is used for:
      # - Database: PostgreSQL database (replaces Render database)
      # - Authentication: User authentication and JWT tokens
      # - Storage: File storage for OCR, RAG, and user uploads
      #
      # Setup Instructions:
      # 1. Create a Supabase project at https://supabase.com
      # 2. Get your project URL and anon key from Settings > API
      # 3. Get database connection string from Settings > Database
      # 4. Set these values in Render dashboard after creating the service
      # ========================================================================
      - key: SUPABASE_URL
        sync: false  # REQUIRED: Set manually in Render dashboard
        # Format: https://[PROJECT_REF].supabase.co
        # Get from: Supabase Dashboard > Settings > API > Project URL

      - key: SUPABASE_ANON_KEY
        sync: false  # REQUIRED: Set manually in Render dashboard
        # Get from: Supabase Dashboard > Settings > API > Project API keys > anon/public key

      - key: SUPABASE_DB_URL
        sync: false  # REQUIRED: Set manually in Render dashboard
        # Get from: Supabase Dashboard > Settings > Database > Connection string
        # Use "Connection pooling" option (port 6543) for serverless/Render
        # Format: postgresql://postgres.[PROJECT_REF]:[PASSWORD]@aws-0-[REGION].pooler.supabase.com:6543/postgres
        #
        # Alternative: If you prefer to use SUPABASE_DB_PASSWORD instead:
        # - key: SUPABASE_DB_PASSWORD
        #   sync: false  # Get from: Supabase Dashboard > Settings > Database > Database password

      # ========================================================================
      # Frontend Configuration
      # ========================================================================
      - key: FRONTEND_HOST
        sync: false  # Set to frontend URL after deployment (e.g., https://synthralos-frontend.onrender.com)

      - key: BACKEND_CORS_ORIGINS
        sync: false  # Set to frontend URL after deployment (e.g., https://synthralos-frontend.onrender.com)

      # ========================================================================
      # Optional: Observability & Monitoring Services
      # ========================================================================
      # See docs/OBSERVABILITY_SETUP.md and docs/WARNINGS_RESOLUTION.md for setup instructions
      #
      # Langfuse (LLM Observability) - RECOMMENDED for Production
      # - key: LANGFUSE_KEY
      #   sync: false  # REQUIRED: Get from https://cloud.langfuse.com > Settings > API Keys
      # - key: LANGFUSE_SECRET_KEY
      #   sync: false  # Optional - defaults to LANGFUSE_KEY if not set
      # - key: LANGFUSE_HOST
      #   value: https://cloud.langfuse.com  # Optional - custom host for self-hosted
      #
      # PostHog (Product Analytics) - RECOMMENDED for Production
      # - key: POSTHOG_KEY
      #   sync: false  # REQUIRED: Get from https://posthog.com > Project Settings > Project API Key
      # - key: POSTHOG_HOST
      #   value: https://app.posthog.com  # Optional - defaults to https://app.posthog.com
      #
      # Wazuh (Security Monitoring) - Optional
      # - key: WAZUH_URL
      #   sync: false  # e.g., http://wazuh:55000 or https://wazuh.example.com
      # - key: WAZUH_USER
      #   sync: false  # Optional - Wazuh API username
      # - key: WAZUH_PASSWORD
      #   sync: false  # Optional - Wazuh API password
      #
      # Signoz (Distributed Tracing) - Optional
      # - key: SIGNOZ_ENDPOINT
      #   sync: false  # e.g., http://signoz:4317 or https://signoz.example.com:4317
      #
      # ChromaDB (Vector Database for RAG) - Optional but Recommended
      # Setup Instructions:
      # 1. Deploy ChromaDB server (self-hosted or use ChromaDB Cloud)
      # 2. For ChromaDB Cloud: Sign up at https://www.trychroma.com/
      # 3. Get your server host from ChromaDB dashboard
      # 4. Set CHROMA_SERVER_HOST in Render dashboard
      # Note: If not configured, RAG will use database-based search (slower but functional)
      - key: CHROMA_SERVER_HOST
        sync: false  # REQUIRED for ChromaDB: e.g., chromadb.example.com or [PROJECT_ID].chromadb.cloud
        # For ChromaDB Cloud: Format is [PROJECT_ID].chromadb.cloud
        # For self-hosted: Use your server hostname or IP

      - key: CHROMA_SERVER_HTTP_PORT
        value: "8000"  # ChromaDB HTTP port (default: 8000, ChromaDB Cloud uses 443)
        # For ChromaDB Cloud, change to "443" and ensure CHROMA_SERVER_HOST includes https://

      - key: CHROMA_SERVER_AUTH_TOKEN
        sync: false  # Optional - Auth token for ChromaDB Cloud (get from ChromaDB dashboard)
        # Only needed for ChromaDB Cloud, not for self-hosted instances
      #
      # Twitter/X API (OSINT) - Optional but Recommended for Social Monitoring
      # Setup Instructions:
      # 1. Create a Twitter Developer account at https://developer.twitter.com/
      # 2. Create a new app/project
      # 3. Generate API keys and Bearer Token
      # 4. Set credentials in Render dashboard
      # Note: Bearer Token is sufficient for most operations (recommended)
      # OAuth credentials (API_KEY, API_SECRET, ACCESS_TOKEN, ACCESS_TOKEN_SECRET) are optional
      - key: TWITTER_BEARER_TOKEN
        sync: false  # RECOMMENDED: Get from https://developer.twitter.com > Your App > Keys and Tokens > Bearer Token
        # Bearer Token is the simplest authentication method for Tweepy

      - key: TWITTER_API_KEY
        sync: false  # Optional: Get from https://developer.twitter.com > Your App > Keys and Tokens > API Key
        # Only needed if using OAuth authentication instead of Bearer Token

      - key: TWITTER_API_SECRET
        sync: false  # Optional: Get from https://developer.twitter.com > Your App > Keys and Tokens > API Secret
        # Only needed if using OAuth authentication instead of Bearer Token

      - key: TWITTER_ACCESS_TOKEN
        sync: false  # Optional: Get from https://developer.twitter.com > Your App > Keys and Tokens > Access Token
        # Only needed if using OAuth authentication instead of Bearer Token

      - key: TWITTER_ACCESS_TOKEN_SECRET
        sync: false  # Optional: Get from https://developer.twitter.com > Your App > Keys and Tokens > Access Token Secret
        # Only needed if using OAuth authentication instead of Bearer Token
      #
      # Sentry (Error Tracking) - Optional
      # - key: SENTRY_DSN
      #   sync: false  # Error tracking - Get from https://sentry.io

      # ========================================================================
      # Optional: Additional Service Configuration
      # ========================================================================
      # - key: FIRST_SUPERUSER
      #   value: admin@synthralos.ai  # Admin email (optional, for initial user creation)
      # - key: FIRST_SUPERUSER_PASSWORD
      #   sync: false  # Admin password (optional, change in production!)
      # - key: REDIS_URL
      #   sync: false
      # - key: OPENAI_API_KEY
      #   sync: false
      # - key: ANTHROPIC_API_KEY
      #   sync: false

      # ========================================================================
      # Nango OAuth Configuration (REQUIRED for connector OAuth)
      # ========================================================================
      # Nango is used for unified OAuth management across all connectors.
      # See docs/NANGO_OAUTH_IMPLEMENTATION.md for setup instructions.
      #
      # Setup Instructions:
      # 1. Create a Nango account at https://nango.dev
      # 2. Configure OAuth apps for each connector provider (Gmail, Slack, etc.)
      # 3. Get your secret key from Nango dashboard > Settings > API Keys
      # 4. Set these values in Render dashboard after creating the service
      # ========================================================================
      - key: NANGO_SECRET_KEY
        sync: false  # REQUIRED: Set manually in Render dashboard
        # Get from: Nango Dashboard > Settings > API Keys > Secret Key

      - key: NANGO_BASE_URL
        value: https://api.nango.dev  # Optional: Defaults to https://api.nango.dev
        # Change this if using self-hosted Nango instance

      - key: NANGO_ENABLED
        value: "true"  # Enable/disable Nango integration

  # Frontend Web Service
  - type: web
    name: synthralos-frontend
    runtime: docker
    dockerfilePath: ./frontend/Dockerfile
    dockerContext: ./frontend
    plan: starter
    buildCommand: ""
    envVars:
      - key: VITE_API_URL
        sync: false  # REQUIRED: Set to backend base URL after backend deploys
        # Format: https://synthralos-backend.onrender.com
        # IMPORTANT: Do NOT include /api/v1 - OpenAPI SDK adds it automatically
        # Backend must be deployed first to get the URL

      - key: VITE_SUPABASE_URL
        sync: false  # REQUIRED: Set to your Supabase project URL
        # Format: https://[PROJECT_REF].supabase.co
        # Get from: Supabase Dashboard > Settings > API > Project URL

      - key: VITE_SUPABASE_ANON_KEY
        sync: false  # REQUIRED: Set to your Supabase anon key
        # Get from: Supabase Dashboard > Settings > API > Project API keys > anon/public key

  # ========================================================================
  # Workflow Worker - Processes workflow executions
  # ========================================================================
  # The worker polls the database every 1 second and executes workflow nodes.
  # This is REQUIRED for workflows to execute - without it, workflows are
  # created but never run.
  #
  # ⚠️  CRITICAL: You MUST set environment variables in Render dashboard!
  # The worker needs the same database connection as the backend.
  #
  # Required Environment Variables (set in Render dashboard):
  # 1. SUPABASE_DB_URL - Database connection string (REQUIRED)
  # 2. SUPABASE_URL - Supabase project URL (REQUIRED)
  # 3. SUPABASE_ANON_KEY - Supabase anonymous key (REQUIRED)
  # 4. SECRET_KEY - Application secret key (REQUIRED)
  # 5. WORKFLOW_WORKER_CONCURRENCY - Concurrent executions (optional, default: 10)
  # 6. All other backend environment variables (NANGO_SECRET_KEY, etc.)
  #
  # See docs/WORKER_ENV_VARS_SETUP.md for detailed setup instructions.
  # ========================================================================
  - type: worker
    name: synthralos-workflow-worker
    runtime: docker
    dockerfilePath: ./backend/Dockerfile.worker
    dockerContext: ./backend
    plan: starter  # $7/month - upgrade to standard ($25/month) for more resources
    envVars:
      - key: ENVIRONMENT
        value: production
      - key: PROJECT_NAME
        value: SynthralOS
      # ⚠️  REQUIRED: Set these in Render dashboard after deployment:
      # - SUPABASE_DB_URL (REQUIRED - database connection string)
      # - SUPABASE_URL (REQUIRED - Supabase project URL)
      # - SUPABASE_ANON_KEY (REQUIRED - Supabase anonymous key)
      # - SECRET_KEY (REQUIRED - application secret key)
      # - WORKFLOW_WORKER_CONCURRENCY (optional, default: 10)
      # - WORKFLOW_NODE_TIMEOUT_SECONDS (optional, default: 300)
      # - All other backend environment variables (NANGO_SECRET_KEY, CHROMA_SERVER_HOST, etc.)

# ============================================================================
# Database Service: NOT INCLUDED
# ============================================================================
#
# This blueprint does NOT include a Render database service because:
# - Database: Supabase PostgreSQL (external service)
# - Authentication: Supabase Auth (external service)
# - Storage: Supabase Storage (external service)
#
# All database operations connect to Supabase PostgreSQL via SUPABASE_DB_URL.
# See backend/app/core/config.py for database connection logic.
#
# Migration Notes:
# - All database migrations are managed via Supabase migrations or Alembic
# - See docs/SUPABASE_DATABASE_MIGRATION.md for migration instructions
# - See docs/MIGRATION_STATUS_REPORT.md for current migration status
#
# ============================================================================
